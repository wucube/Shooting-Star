using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Serialization;
using UnityEngine.UI;

public class StatsBar : MonoBehaviour
{
    //???????
    [SerializeField] Image fillImageBack;
    //??????
    [SerializeField] Image fillImageFront;
    //????????????
    [SerializeField] bool delayFill = true;
    //?????????
    [SerializeField] float fillDelay = 0.5f;
    
    //???????????
    [SerializeField] float fillSpeed = 0.1f;
    
    //?????????
    private float _currentFillAmount; 
    //?????????
    protected float targetFillAmount; 
    //????????? 
    private float _previousFillAmount; 
    //???????????????
    private float _t;
    //???????????????
    WaitForSeconds waitForDelayFill;
    //§¿???????????›¥????????§¿??
    Coroutine bufferedFillingCoroutine;
    
    private void Awake()
    {
        //??§Ý????????????
        if (TryGetComponent<Canvas>(out Canvas canvas))
        {
            //?????????????????,????????????
            canvas.worldCamera = Camera.main;
        }
           
        //??????????????????
        waitForDelayFill = new WaitForSeconds(fillDelay);
    }
    //?????????????????§¿??
    private void OnDisable()
    {
        StopAllCoroutines();
    }
    //?????????
    public virtual void Initialize(float currentValue,float maxValue)
    {
        //??????/????????? ???? ?????????
        _currentFillAmount = currentValue / maxValue;
        //????????? ???? ???????
        targetFillAmount = _currentFillAmount;
        //????????? ???? ????????????
        //??????????????????? ????????????
        fillImageBack.fillAmount = _currentFillAmount;
        fillImageFront.fillAmount = _currentFillAmount;  
    }

    //???????? ????????£???????¨²???
    public void UpdateStats(float currentValue,float maxValue)
    {
        //??????? ? ??????/????
        targetFillAmount = currentValue/ maxValue;
        //????§¿??????????§¿??
        if(bufferedFillingCoroutine!=null)
            StopCoroutine(bufferedFillingCoroutine);
        // ????????????????????????? ???? ??????? 
        if (_currentFillAmount > targetFillAmount)
        {
            //???????????=???????
            fillImageFront.fillAmount = targetFillAmount;
            //????????????????????????????????§¿?????????????????
            bufferedFillingCoroutine = StartCoroutine(BufferedFillingCoroutine(fillImageBack));
        }
        // ??????????
        else if(_currentFillAmount < targetFillAmount)
        {
            //???????????? = ???????
            fillImageBack.fillAmount = targetFillAmount;
            // ????????????????????????????????§¿?????????????????
            bufferedFillingCoroutine = StartCoroutine(BufferedFillingCoroutine(fillImageFront));
        }
    }
    
    //???????§¿??
    protected virtual IEnumerator BufferedFillingCoroutine(Image image)
    {
        //???????????????????
        if (delayFill) yield return waitForDelayFill;
        //?????????????
        _previousFillAmount = _currentFillAmount;
        
        _t = 0;
        while (_t < 1f)
        {
            //??? t 
            _t += Time.deltaTime * fillSpeed;
            //??????? ??? ???????
            _currentFillAmount = Mathf.Lerp(_previousFillAmount, targetFillAmount, _t);
            //??????? ???? ??????
            image.fillAmount = _currentFillAmount;
            //????????
            yield return null;
        }
    }
}
